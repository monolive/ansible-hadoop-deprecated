#!/bin/bash

# Define Ganglia service
/usr/bin/curl -u admin:admin -H "X-Requested-By: ambari" -X POST http://{{ hostvars[groups['ambari_server'][0]]['ansible_fqdn'] }}:8080/api/v1/clusters/{{ hdp['CLUSTERNAME']}}/services/GANGLIA > /root/ambari-install/install-ganglia.log

# Define ganglia server
/usr/bin/curl -u admin:admin -H "X-Requested-By: ambari" -X POST http://{{ hostvars[groups['ambari_server'][0]]['ansible_fqdn'] }}:8080/api/v1/clusters/{{ hdp['CLUSTERNAME']}}/services/GANGLIA/components/GANGLIA_SERVER >> /root/ambari-install/install-ganglia.log
/usr/bin/curl -u admin:admin -H "X-Requested-By: ambari" -X POST http://{{ hostvars[groups['ambari_server'][0]]['ansible_fqdn'] }}:8080/api/v1/clusters/{{ hdp['CLUSTERNAME']}}/hosts/{{ hostvars[groups['ambari_server'][0]]['ansible_fqdn'] }}/host_components/GANGLIA_SERVER >> /root/ambari-install/install-ganglia.log
/usr/bin/curl -u admin:admin -H "X-Requested-By: ambari" -X PUT -d '{"HostRoles": {"state": "INSTALLED"}}' http://{{ hostvars[groups['ambari_server'][0]]['ansible_fqdn'] }}:8080/api/v1/clusters/{{ hdp['CLUSTERNAME']}}/hosts/{{ hostvars[groups['ambari_server'][0]]['ansible_fqdn'] }}/host_components/GANGLIA_SERVER >> /root/ambari-install/install-ganglia.log

# Define server to monitor
/usr/bin/curl -u admin:admin -H "X-Requested-By: ambari" -X POST http://{{ hostvars[groups['ambari_server'][0]]['ansible_fqdn'] }}:8080/api/v1/clusters/{{ hdp['CLUSTERNAME']}}/services/GANGLIA/components/GANGLIA_MONITOR >> /root/ambari-install/install-ganglia.log
{% for host in groups['datanode'] %}
/usr/bin/curl -u admin:admin -H "X-Requested-By: ambari" -X POST http://{{ hostvars[groups['ambari_server'][0]]['ansible_fqdn'] }}:8080/api/v1/clusters/{{ hdp['CLUSTERNAME']}}/hosts/{{ hostvars[host]['ansible_fqdn'] }}/host_components/GANGLIA_MONITOR >> /root/ambari-install/install-ganglia.log
/usr/bin/curl -u admin:admin -H "X-Requested-By: ambari" -X PUT -d '{"HostRoles": {"state": "INSTALLED"}}' http://{{ hostvars[groups['ambari_server'][0]]['ansible_fqdn'] }}:8080/api/v1/clusters/{{ hdp['CLUSTERNAME']}}/hosts/{{ hostvars[host]['ansible_fqdn'] }}/host_components/GANGLIA_MONITOR >> /root/ambari-install/install-ganglia.log

{% endfor %}

# Start the installation
/usr/bin/curl -u admin:admin -H \"X-Requested-By: ambari\" -X PUT -d '{\"RequestInfo\":{\"context\":\"Install GANGLIA\"}, \"Body\":{\"ServiceInfo\": {\"state\":\"INSTALLED\"}}}' http://{{ hostvars[groups['ambari_server'][0]]['ansible_fqdn'] }}:8080/api/v1/clusters/{{ hdp['CLUSTERNAME']}}/services/GANGLIA >> /root/ambari-install/install-ganglia.log
