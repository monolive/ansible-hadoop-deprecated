#!/bin/bash

# Define cluster
/usr/bin/curl -u admin:admin -H "X-Requested-By: ambari" -X POST -d '{"RequestInfo":{"context":"Define cluster"}, "Body":{"Clusters": {"version": "HDP-{{ hdp['HDP_VERSION'] }}" }}}' http://{{ hostvars[groups['ambari_server'][0]]['ansible_fqdn'] }}:8080/api/v1/clusters/{{ hdp['CLUSTERNAME'] }} > /root/ambari-install/create-cluster.log

sleep 20

# Add hosts to cluster
{% for host in groups['all'] %}
/usr/bin/curl -u admin:admin -H "X-Requested-By: ambari" -X POST http://{{ hostvars[groups['ambari_server'][0]]['ansible_fqdn'] }}:8080/api/v1/clusters/{{ hdp['CLUSTERNAME'] }}/hosts/{{ hostvars[host]['ansible_fqdn'] }} >> /root/ambari-install/create-cluster.log
{% endfor %}

/usr/bin/curl -i -u admin:admin -H "X-Requested-By: ambari" -X POST -d '{ "CLUSTER_CURRENT_STATUS": "{\"clusterState\":\"CLUSTER_STARTED_5\"}" }' http://{{ hostvars[groups['ambari_server'][0]]['ansible_fqdn'] }}:8080/api/v1/persist
